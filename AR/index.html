<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>VFI Model — Image‑Tracked WebAR (Layers)</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #app { position: fixed; inset: 0; overflow: hidden; }
    .ui { position: fixed; inset: 0; display: grid; place-items: start center; pointer-events: none; padding: 16px; }
    .panel { pointer-events: auto; background: rgba(12,12,14,.7); backdrop-filter: blur(6px); border-radius: 14px; padding: 14px 16px; max-width: 720px; width: min(720px, calc(100% - 32px)); box-shadow: 0 12px 30px rgba(0,0,0,.35); }
    .panel h1 { margin: 0 0 8px; font-size: 18px; }
    .row { display:flex; flex-wrap: wrap; gap:10px; align-items:center; }
    .hint { font-size:12px; opacity:.85; margin-top:6px; }
    .hidden { display:none !important; }
    button { cursor: pointer; border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 600; background:#4f46e5; color:#fff; }
    button.secondary { background:#374151; }
    .layers { display:flex; flex-wrap: wrap; gap:8px; margin-top:10px; }
    .toggle { background:#1f2937; padding:8px 10px; border-radius:10px; display:flex; align-items:center; gap:8px; }
    .toggle input { width:18px; height:18px; accent-color:#4f46e5; }
    body { padding: env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <div id="app"></div>
  <div class="ui">
    <div id="panel" class="panel">
      <h1>Start AR</h1>
      <div class="row">
        <button id="startBtn">Enable Camera</button>
        <button id="flipBtn" class="secondary">Flip Camera</button>
      </div>
      <div class="row" style="margin-top:8px;gap:8px;">
        <button id="showAll" class="secondary">Show all</button>
        <button id="hideAll" class="secondary">Hide all</button>
      </div>
      <div class="hint">Point your phone at the engraved corner target on the wooden base.</div>
      <div id="layerToggles" class="layers"></div>
    </div>
  </div>
  <img id="_preImg" class="hidden" />
  <script>
    const TARGETS_FILE = 'targets.mind';
    const MODEL_WIDTH_M = 0.15;
    const LAYERS = [
      { id: 'Aerial + massing', type: 'image', src: 'layers/1.png', width: MODEL_WIDTH_M },
      { id: 'Grass + roads', type: 'image', src: 'layers/2.png', width: MODEL_WIDTH_M },
      { id: 'Linework', type: 'image', src: 'layers/3.png', width: MODEL_WIDTH_M },
      { id: 'Simplified plan', type: 'image', src: 'layers/4.png', width: MODEL_WIDTH_M },
      { id: 'Parcel mask', type: 'image', src: 'layers/5.png', width: MODEL_WIDTH_M }
    ];
    const appEl = document.getElementById('app');
    const meshes = new Map();
    LAYERS.forEach(layer => {
      const wrap = document.createElement('label');
      wrap.className = 'toggle';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.addEventListener('change', () => { const m = meshes.get(layer.id); if (m) m.visible = cb.checked; });
      wrap.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = layer.id;
      wrap.appendChild(span);
      document.getElementById('layerToggles').appendChild(wrap);
      layer.__checkbox = cb;
    });
    document.getElementById('showAll').addEventListener('click', () => {
      LAYERS.forEach(l => { l.__checkbox.checked = true; const m = meshes.get(l.id); if (m) m.visible = true; });
    });
    document.getElementById('hideAll').addEventListener('click', () => {
      LAYERS.forEach(l => { l.__checkbox.checked = false; const m = meshes.get(l.id); if (m) m.visible = false; });
    });
    let mindarThree, renderer, scene, camera, anchor, overlayRoot;
    async function initAR() {
      await stopAR();
      try {
        mindarThree = new window.MINDAR.IMAGE.MindARThree({ container: appEl, imageTargetSrc: TARGETS_FILE, maxTrack: 1, facingMode: 'environment' });
        ({renderer, scene, camera} = mindarThree);
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));
        anchor = mindarThree.addAnchor(0);
        overlayRoot = new THREE.Group();
        anchor.group.add(overlayRoot);
        for (const layer of LAYERS) {
          const mesh = await buildImageMesh(layer.src, layer.width);
          mesh.visible = false;
          overlayRoot.add(mesh);
          meshes.set(layer.id, mesh);
        }
        await mindarThree.start();
        document.getElementById('panel').classList.add('hidden');
        renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
      } catch (err) {
        alert('Error starting AR: ' + err);
        console.error(err);
      }
    }
    async function buildImageMesh(src, widthM) {
      const img = document.getElementById('_preImg');
      img.src = src;
      await img.decode().catch(()=>{});
      const tex = new THREE.Texture(img);
      tex.needsUpdate = true;
      const aspect = (img.naturalWidth && img.naturalHeight) ? img.naturalWidth / img.naturalHeight : 1;
      const geom = new THREE.PlaneGeometry(widthM, widthM / aspect);
      const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
      return new THREE.Mesh(geom, mat);
    }
    async function stopAR() {
      try { if (mindarThree) { await mindarThree.stop(); mindarThree.renderer.setAnimationLoop(null); while (appEl.firstChild) appEl.removeChild(appEl.firstChild); mindarThree = null; } } catch (e) { console.warn(e); }
    }
    document.getElementById('startBtn').addEventListener('click', initAR);
    document.getElementById('flipBtn').addEventListener('click', async () => { await stopAR(); mindarThree = null; initAR(); });
  </script>
</body>
</html>
